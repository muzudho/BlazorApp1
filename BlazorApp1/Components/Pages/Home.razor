@page "/"
@using BlazorApp1.Components.Shared
@rendermode InteractiveServer	// ボタンの @onclick に必要
@inject NavigationManager NavigationMgr

<PageTitle>Home</PageTitle>

<h1>Hello, world!</h1>

Welcome to your new app.

<table>
	<th>
		<td>名前</td>
		<td>値</td>
	</th>
	<tr>
		<td>アップル</td>
		<td>@this.UrlApple</td>
	</tr>
	<tr>
		<td>バナナ</td>
		<td>@this.UrlBanana</td>
	</tr>
	<tr>
		<td>チェリー</td>
		<td>@this.UrlCherry</td>
	</tr>
	<tr>
		<td>ドリアン</td>
		<td>@this.UrlDurian</td>
	</tr>
	<tr>
		<td>エッグ</td>
		<td>@this.UrlEgg</td>
	</tr>
	<tr>
		<td>フィグ</td>
		<td>@this.UrlFig</td>
	</tr>
	<tr>
		<td>グレープ</td>
		<td>@this.UrlGrape</td>
	</tr>
</table>

<ul>
	<li><a href="https://localhost:7249/">https://localhost:7249/</a></li>
	<li><a href="https://localhost:7249/?apple=&banana=true&cherry=false&durian=&egg=100&fig=&grape=RichFlavor">https://localhost:7249/?apple=&banana=true&cherry=false&durian=&egg=100&fig=&grape=RichFlavor</a></li>
	<li><a href="https://localhost:7249/?apple=false&banana=true&cherry=false&durian=&egg=100&fig=&grape=RichFlavor">https://localhost:7249/?apple=&banana=true&cherry=false&durian=&egg=100&fig=&grape=RichFlavor</a></li>
</ul>

<button @onclick="NavigateToSamePage">自分のページへ飛ぶ</button><br/>

<p>初期化回数： @this.InitializationCount</p>
<p>ページ遷移回数： @this.LeaveCount</p>
<p>レンダー回数： @this.RenderingCount</p>
<p>メッセージ： @this.Message</p>

<ExBananaComponent
	Apple="@this.UrlApple"></ExBananaComponent>

@code
{


	// ========================================
	// パラメーター
	// ========================================
	//
	//		- クエリーパラメーター（URLの引数）は string? 型で受け取ってください。
	//		- 値の初期化は `OnParametersSet()` または `OnParametersSetAsync()` 関数で行ってください。

	/// <summary>
	///		<pre>
	///	アップル
	///	
	///		- ［期待］bool 型
	///		- ［ヌル／空文字列／パース失敗］時： "True"
	///		</pre>
	/// </summary>
	[Parameter]
	[SupplyParameterFromQuery(Name = "Apple")]
	public string? UrlApple { get; set; }

	/// <summary>
	///		<pre>
	///	バナナ
	///
	///		- ［期待］bool 型
	///		- ［ヌル／空文字列／パース失敗］時： "False"
	///		</pre>
	/// </summary>
	[Parameter]
	[SupplyParameterFromQuery(Name = "Banana")]
	public string? UrlBanana { get; set; }

	/// <summary>
	/// チェリー
	/// 
	///		- ［期待］bool 型
	///		- ［ヌル／空文字列／パース失敗］時： "False"
	/// </summary>
	[Parameter]
	[SupplyParameterFromQuery(Name = "Cherry")]
	public string? UrlCherry { get; set; }

	/// <summary>
	/// ドリアン
	///
	///		- ［期待］int 型
	///		- ［ヌル／空文字列／パース失敗］時： ヌル
	/// </summary>
	[Parameter]
	[SupplyParameterFromQuery(Name = "Durian")]
	public string? UrlDurian { get; set; }

	/// <summary>
	/// エッグ
	///
	///		- ［期待］int 型
	///		- ［ヌル／空文字列／パース失敗］時： "7"
	/// </summary>
	[Parameter]
	[SupplyParameterFromQuery(Name = "Egg")]
	public string? UrlEgg { get; set; }

	/// <summary>
	/// フィグ
	///
	///		- ［期待］string 型
	///		- ［ヌル／空文字列］時： "Ichijiku"
	/// </summary>
	[Parameter]
	[SupplyParameterFromQuery(Name = "Fig")]
	public string? UrlFig { get; set; }

	/// <summary>
	/// グレープ
	///
	///		- ［期待］string 型
	///		- ［ヌル／空文字列］時： ""
	/// </summary>
	[Parameter]
	[SupplyParameterFromQuery(Name = "Grape")]
	public string? UrlGrape { get; set; }


	// ========================================
	// プロパティ
	// ========================================


	/// <summary>
	/// 何かメッセージ
	/// </summary>
	private string Message { get; set; } = string.Empty;

	/// <summary>
	///		<pre>
	/// 初期化回数
	/// 
	///		- 0 から 1 になるだけのはず。2 になるはずがない。
	///		</pre>
	/// </summary>
	private int InitializationCount = 0;

	/// <summary>
	///		<pre>
	///	ページ遷移回数
	///	
	///		- 同じページに再アクセスしたとき、値が残っている。（ `OnInitializeAsync()` メソッドを除く）
	///		</pre>
	/// </summary>
	private int LeaveCount = 0;

	/// <summary>
	///		<pre>
	///	レンダー回数
	///		</pre>
	/// </summary>
	private int RenderingCount = 0;


	// ========================================
	// ライフサイクルメソッド
	// ========================================


	/// <summary>
	///		<pre>
	///	対応する URL にアクセスされ、このページのインスタンスが生成されたときに呼び出されます。
	///	
	///		- 同じページに再アクセスしたとき、このメソッドは呼び出されるが、そのとき、このページのインスタンスのプロパティは初期値に戻っている。しかし、レンダーすると、前の値が残っている。仕組みがさっぱり分からない。
	///		</pre>
	/// </summary>
	/// <returns></returns>
	protected override async Task OnInitializedAsync()
	{
		await base.OnInitializedAsync();
		System.Console.WriteLine($"[{DateTime.Now}][Home.razor > ＯnInitialized]　🔥　ページ・インスタンス生成");

		var oldInitializationCount = this.InitializationCount;
		this.InitializationCount++;
		System.Console.WriteLine($"[{DateTime.Now}][Home.razor > ＯnInitialized]　ページ初期化回数： （{oldInitializationCount}→{this.InitializationCount}）　ちなみにページ遷移回数： {this.LeaveCount}");
	}


	/// <summary>
	///		<pre>
	/// パラメーターセット時
	/// 
	///		- レンダー実行時に呼び出されます。
	///		</pre>
	/// </summary>
	/// <returns></returns>
	protected override async Task OnParametersSetAsync()
	{
		await base.OnParametersSetAsync();

		System.Console.WriteLine($"[{DateTime.Now}][Home.razor > ＯnParametersSetAsync]　🔥　パラメーターズセット");

		if (string.IsNullOrWhiteSpace(this.UrlApple) || !bool.TryParse(this.UrlApple, out var urlApple))
		{
			this.UrlApple = true.ToString();
		}
		else
		{
			this.UrlApple = urlApple.ToString();
		}

		if (string.IsNullOrWhiteSpace(this.UrlBanana) || !bool.TryParse(this.UrlBanana, out var urlBanana))
		{
			this.UrlBanana = false.ToString();
		}
		else
		{
			this.UrlBanana = urlBanana.ToString();
		}

		if (string.IsNullOrWhiteSpace(this.UrlCherry) || !bool.TryParse(this.UrlCherry, out var urlCherry))
		{
			this.UrlCherry = null;
		}
		else
		{
			this.UrlCherry = urlCherry.ToString();
		}

		if (string.IsNullOrWhiteSpace(this.UrlDurian) || !int.TryParse(this.UrlDurian, out var urlDurian))
		{
			this.UrlDurian = null;
		}
		else
		{
			this.UrlDurian = urlDurian.ToString();
		}

		if (string.IsNullOrWhiteSpace(this.UrlEgg) || !int.TryParse(this.UrlEgg, out var urlEgg))
		{
			this.UrlEgg = 7.ToString();
		}
		else
		{
			this.UrlEgg = urlEgg.ToString();
		}

		if (string.IsNullOrWhiteSpace(this.UrlFig))
		{
			this.UrlFig = "Ichijiku";
		}

		if (string.IsNullOrWhiteSpace(this.UrlGrape))
		{
			this.UrlGrape = string.Empty;
		}
	}


	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		await base.OnAfterRenderAsync(firstRender);

		this.RenderingCount++;
		System.Console.WriteLine($"[{DateTime.Now}][Home.razor > ＯnAfterRenderAsync]　描画後　firstRender = {firstRender}, RenderingCount = {this.RenderingCount}");

		if (firstRender)
		{
			await this.InvokeAsync(this.StateHasChanged);	// `OnAfterRenderAsync()` 内で何か更新したら、もう１回再描画が必須。
		}
	}


	// ========================================
	// イベントハンドラ
	// ========================================


	private void NavigateToSamePage()
	{
		System.Console.WriteLine("[{DateTime.Now}][Home.razor > ＮavigateToSamePage]　🔥　このページにまた飛ぶ");

		// 画面遷移しても、不思議なことにこのメッセージは残る。
		this.Message = "同じページへ飛んだ。";

		this.NavigationMgr.NavigateTo("https://localhost:7249/");
		this.LeaveCount++;
	}
}
